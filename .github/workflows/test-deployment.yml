name: Test Deployment

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-deployment:
    runs-on: ubuntu-latest
    services:
      surfpool:
        image: surfpool/surfpool
        options: -n devnet
        ports:
          - 8899:8899
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: 'package.json'

      - name: Install dependencies
        run: bun install

      - name: Generate deployer keypair
        run: ./bank init

      - name: Install Solana CLI
        run: |
          sh -c "$(curl -sSfL https://release.anza.xyz/stable/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: Airdrop SOL to deployer
        run: |
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          DEPLOYER_PUBKEY=$(jq -r .publicKey secrets/deployer.json)
          echo "Deployer public key: $DEPLOYER_PUBKEY"
          solana config set --url http://localhost:8899
          solana airdrop 10 "$DEPLOYER_PUBKEY"

      - name: Run deployment
        run: ./bank launch --cluster local --send
