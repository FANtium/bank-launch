name: Test Deployment

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-deployment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: 'package.json'

      - name: Install dependencies
        run: bun install

      - name: Generate deployer keypair
        run: ./bank init

      - name: Install and start Surfpool
        run: |
          curl -sL https://run.surfpool.run/ | bash
          echo "$HOME/.surfpool/bin" >> $GITHUB_PATH
          export PATH="$HOME/.surfpool/bin:$PATH"
          surfpool start -n devnet &
          for i in {1..30}; do
            if curl -s http://localhost:8899/health > /dev/null 2>&1; then
              echo "Surfpool is ready"
              break
            fi
            echo "Waiting for Surfpool... ($i/30)"
            sleep 1
          done

      - name: Install Solana CLI
        run: |
          sh -c "$(curl -sSfL https://release.anza.xyz/stable/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: Airdrop SOL to deployer
        run: |
          DEPLOYER_PUBKEY=$(jq -r .publicKey secrets/deployer.json)
          echo "Deployer public key: $DEPLOYER_PUBKEY"
          solana config set --url http://localhost:8899
          solana airdrop 10 "$DEPLOYER_PUBKEY"

      - name: Run deployment
        run: ./bank launch --cluster local --send

      - name: Stop Surfpool
        if: always()
        run: pkill surfpool || true
